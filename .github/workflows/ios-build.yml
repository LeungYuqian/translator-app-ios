name: Build iOS App

# 触发条件：推送到main分支或手动触发
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-ios:
    name: Build iOS App
    runs-on: macos-13  # 使用macOS 13以获得更稳定的Xcode版本
    
    steps:
    # 检出代码
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    # 设置Node.js环境
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: 'package-lock.json'
    
    # 安装依赖
    - name: Install Dependencies
      run: |
        npm ci
        npm install -g @ionic/cli @capacitor/cli
    
    # 构建Web应用
    - name: Build Web App
      run: |
        npm run build
    
    # 同步到iOS平台
    - name: Sync iOS Platform
      run: |
        npx cap sync ios
    
    # 设置Xcode版本
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    # 安装CocoaPods依赖
    - name: Install CocoaPods Dependencies
      run: |
        cd ios/App
        # 清理CocoaPods缓存
        pod cache clean --all
        # 更新CocoaPods仓库
        pod repo update --silent
        # 安装依赖，跳过警告
        pod install --verbose
    
    # 设置临时keychain（避免签名相关错误）
    - name: Setup Keychain
      run: |
        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        security set-keychain-settings -t 3600 -u build.keychain
    
    # 构建iOS应用（无签名版本用于测试）
    - name: Build iOS App (Debug)
      run: |
        cd ios/App
        # 设置构建环境变量
        export CODE_SIGNING_REQUIRED=NO
        export CODE_SIGNING_ALLOWED=NO
        
        # 获取可用的iOS模拟器SDK版本
        echo "Available SDKs:"
        xcodebuild -showsdks | grep iphonesimulator
        
        # 尝试多种方式获取SDK版本
        IOS_SDK=$(xcodebuild -showsdks | grep iphonesimulator | tail -1 | awk '{print $NF}')
        echo "Detected iOS SDK: $IOS_SDK"
        
        # 验证SDK是否有效，如果无效则尝试其他方式
        if [ -z "$IOS_SDK" ] || ! xcodebuild -showsdks | grep -q "$IOS_SDK"; then
          # 尝试获取默认的模拟器SDK
          IOS_SDK=$(xcrun --sdk iphonesimulator --show-sdk-name 2>/dev/null || echo "iphonesimulator")
          echo "Using fallback SDK: $IOS_SDK"
        fi
        
        # 最后的保险措施
        if [ -z "$IOS_SDK" ]; then
          IOS_SDK="iphonesimulator"
          echo "Using final fallback SDK: $IOS_SDK"
        fi
        
        # 获取可用的iOS模拟器设备和运行时版本
        echo "Available iOS Simulators:"
        xcrun simctl list devices available
        
        # 获取第一个可用的iPhone模拟器及其iOS版本
        SIMULATOR_INFO=$(xcrun simctl list devices available | grep iPhone | head -1)
        echo "Selected simulator info: $SIMULATOR_INFO"
        
        # 提取设备名称（不包含版本号）
        SIMULATOR_DEVICE=$(echo "$SIMULATOR_INFO" | sed 's/.*\(iPhone [0-9]*[^(]*\).*/\1/' | xargs)
        if [ -z "$SIMULATOR_DEVICE" ]; then
          SIMULATOR_DEVICE="iPhone 15"
        fi
        
        # 提取iOS版本
        IOS_VERSION=$(echo "$SIMULATOR_INFO" | sed 's/.*(\([0-9]*\.[0-9]*\).*/\1/')
        if [ -z "$IOS_VERSION" ]; then
          # 如果无法提取版本，使用SDK版本
          IOS_VERSION=$(echo "$IOS_SDK" | sed 's/iphonesimulator\([0-9]*\.[0-9]*\)/\1/')
          if [ -z "$IOS_VERSION" ] || [ "$IOS_VERSION" = "$IOS_SDK" ]; then
            IOS_VERSION="17.0"  # 使用稳定的默认版本
          fi
        fi
        
        echo "Using device: $SIMULATOR_DEVICE with iOS: $IOS_VERSION"
        
        # 构建应用 - 使用generic/platform避免特定设备问题
        echo "Building with SDK: $IOS_SDK"
        
        xcodebuild -workspace App.xcworkspace \
                   -scheme App \
                   -configuration Debug \
                   -destination "generic/platform=iOS Simulator" \
                   -sdk "$IOS_SDK" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO \
                   PROVISIONING_PROFILE= \
                   CODE_SIGN_IDENTITY= \
                   DEVELOPMENT_TEAM= \
                   -allowProvisioningUpdates \
                   clean build
    
    # 上传构建产物
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-debug
        path: ios/App/build/Debug-iphonesimulator/
        retention-days: 30

  # 发布版本构建（需要证书和配置文件）
  build-ios-release:
    name: Build iOS App for Release
    runs-on: macos-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    # 检出代码
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    # 设置Node.js环境
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: 'package-lock.json'
    
    # 安装依赖
    - name: Install Dependencies
      run: |
        npm ci
        npm install -g @ionic/cli @capacitor/cli
    
    # 构建Web应用
    - name: Build Web App
      run: |
        npm run build
    
    # 同步到iOS平台
    - name: Sync iOS Platform
      run: |
        npx cap sync ios
    
    # 设置Xcode版本
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    # 安装CocoaPods依赖
    - name: Install CocoaPods Dependencies
      run: |
        cd ios/App
        pod install
    
    # 导入证书和配置文件（需要在GitHub Secrets中配置）
    - name: Import Code Signing Certificates
      env:
        P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        CERTIFICATE_P12: ${{ secrets.CERTIFICATE_P12 }}
        PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
      run: |
        # 创建临时keychain
        security create-keychain -p "temp_password" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "temp_password" build.keychain
        
        # 导入证书
        echo "$CERTIFICATE_P12" | base64 --decode > certificate.p12
        security import certificate.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign
        
        # 导入配置文件
        echo "$PROVISIONING_PROFILE" | base64 --decode > profile.mobileprovision
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
        
        # 设置keychain权限
        security set-key-partition-list -S apple-tool:,apple: -s -k "temp_password" build.keychain
      if: env.CERTIFICATE_P12 != ''
    
    # 构建和签名iOS应用
    - name: Build and Sign iOS App
      env:
        CODE_SIGN_IDENTITY: ${{ secrets.CODE_SIGN_IDENTITY }}
        PROVISIONING_PROFILE_UUID: ${{ secrets.PROVISIONING_PROFILE_UUID }}
      run: |
        cd ios/App
        xcodebuild -workspace App.xcworkspace \
                   -scheme App \
                   -configuration Release \
                   -destination 'generic/platform=iOS' \
                   -archivePath $PWD/build/App.xcarchive \
                   CODE_SIGN_IDENTITY="$CODE_SIGN_IDENTITY" \
                   PROVISIONING_PROFILE="$PROVISIONING_PROFILE_UUID" \
                   archive
    
    # 导出IPA文件
    - name: Export IPA
      run: |
        cd ios/App
        # 创建导出选项plist文件
        cat > ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>${{ secrets.TEAM_ID }}</string>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
        </dict>
        </plist>
        EOF
        
        # 导出IPA
        xcodebuild -exportArchive \
                   -archivePath $PWD/build/App.xcarchive \
                   -exportPath $PWD/build/ipa \
                   -exportOptionsPlist ExportOptions.plist
      if: env.CODE_SIGN_IDENTITY != ''
    
    # 上传IPA文件
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-release
        path: ios/App/build/ipa/*.ipa
        retention-days: 90
      if: env.CODE_SIGN_IDENTITY != ''
    
    # 清理keychain
    - name: Cleanup
      run: |
        # 安全删除keychain，忽略错误
        security delete-keychain build.keychain || true
        # 清理临时文件
        rm -f certificate.p12 profile.mobileprovision || true
      if: always()